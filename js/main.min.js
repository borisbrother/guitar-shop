(()=>{"use strict";const e={products:document.querySelector("#products"),header:document.querySelector("#header"),shopping:document.querySelector("#shopping")},t=new class{constructor(){this.keyName="products",this.values=null!=localStorage.getItem(this.keyName)?JSON.parse(localStorage.getItem(this.keyName)):{},this.qty=this.countQty()}countQty(){let e=0;for(let t in this.values)e+=this.values[t];return e}getProducts(){return this.values}getQty(){return this.qty}saveProducts(){localStorage.setItem(this.keyName,JSON.stringify(this.values))}addProduct(e,t=1){this.qty+=t,this.values[e]=t,this.saveProducts()}deleteProduct(e){this.qty-=this.values[e],delete this.values[e],this.saveProducts()}switchProduct(e){let t;return e in this.values?(this.deleteProduct(e),t=!1):(this.addProduct(e),t=!0),{status:t,products:this.values}}};let n=new class{async getCatalog(){let e=await fetch("http://myjson.dit.upm.es/api/bins/9g4s");if(200!==e.status)throw new Error("Ошибка подключения");return await e.json()}};class s{constructor(e){this.el=e,this.productList={},this.indexID()}async indexID(){try{let e=await n.getCatalog();this.productList=e.reduce(((e,t)=>(e[[t.id]]=t,e)),{})}catch(e){console.log(e)}}static labels(){return{activeClassLabel:"active",addLabel:"Добавить в корзину",removeLabel:"Удалить из корзины"}}async render(){this.el.innerHTML="";const e=t.getProducts(),o=document.createElement("ul");o.classList.add("products__container");try{(await n.getCatalog()).forEach((t=>{const n={activeClass:"",activeText:""};t.id in e?(n.activeClass=s.labels().activeClassLabel,n.activeText=s.labels().removeLabel):(n.activeClass="",n.activeText=s.labels().addLabel),o.appendChild(s.renderElementLi(t,n))})),this.el.appendChild(o)}catch(e){console.log(e)}}getProduct(e){return this.productList[e]}static renderElementLi({id:e,productName:n,price:o,img:r},a){const i=document.createElement("li");return i.classList.add("products__item"),i.innerHTML=`<div class="products__inner">\n      <span class="products__title">${n}</span>\n      <img src="${r}" alt="${n}" class="products__img">\n      <div class="products__footer">          \n        <div class="products__price">\n        <img src="images/plugin.png" class="products__icon">\n        ${o.toLocaleString("ru-RU",{style:"currency",currency:"RUR"})}\n        </div>\n        <button class="${a.activeClass}">${a.activeText}</button>\n      </div>\n    <div>`,i.querySelector("button").addEventListener("click",(n=>{let{status:o}=t.switchProduct(e);o?(n.target.classList.add(s.labels().activeClassLabel),n.target.innerHTML=`${s.labels().removeLabel}`):(n.target.classList.remove(s.labels().activeClassLabel),n.target.innerHTML=`${s.labels().addLabel}`),_.render()})),i}}const o=new s(e.products);var r=!1;if("undefined"!=typeof window){var a={get passive(){r=!0}};window.addEventListener("testPassive",null,a),window.removeEventListener("testPassive",null,a)}var i="undefined"!=typeof window&&window.navigator&&window.navigator.platform&&(/iP(ad|hone|od)/.test(window.navigator.platform)||"MacIntel"===window.navigator.platform&&window.navigator.maxTouchPoints>1),c=[],l=!1,d=-1,u=void 0,p=void 0,h=void 0,v=function(e){return c.some((function(t){return!(!t.options.allowTouchMove||!t.options.allowTouchMove(e))}))},m=function(e){var t=e||window.event;return!!v(t.target)||t.touches.length>1||(t.preventDefault&&t.preventDefault(),!1)};class g{constructor(e){this.el=e,this.el.addEventListener("click",(e=>{var t;this.el.classList.remove("active"),document.body.classList.remove("lock"),(t=document.body)?(c=c.filter((function(e){return e.targetElement!==t})),i&&(t.ontouchstart=null,t.ontouchmove=null,l&&0===c.length&&(document.removeEventListener("touchmove",m,r?{passive:!1}:void 0),l=!1)),i?function(){if(void 0!==p){var e=-parseInt(document.body.style.top,10),t=-parseInt(document.body.style.left,10);document.body.style.position=p.position,document.body.style.top=p.top,document.body.style.left=p.left,window.scrollTo(t,e),p=void 0}}():(void 0!==h&&(document.body.style.paddingRight=h,h=void 0),void 0!==u&&(document.body.style.overflow=u,u=void 0))):console.error("enableBodyScroll unsuccessful - targetElement must be provided when calling enableBodyScroll on IOS devices.")}))}render(){this.el.innerHTML="";const e=document.createElement("ul");e.classList.add("shopping__container"),e.addEventListener("click",(e=>e.stopPropagation()));let n=1,s=0;const r=document.createElement("li");r.classList.add("shopping__element","shopping__element_header"),r.innerHTML='<span class="shopping__counter">№ п/п</span>\n    <span class="shopping__productName">Наименование продукта</span>\n    <span class="shopping__qty">Коли&shy;чество</span>\n    <span class="shopping__price">Цена</span>\n    <span class="shopping__button"></span>',e.appendChild(r),Object.keys(t.values).forEach((r=>{const a=o.getProduct(r);if(!a)return;const i=t.values[r];e.appendChild(g.renderLi(n,a,i)),n++,s+=a.price}));const a=document.createElement("li");a.classList.add("shopping__element","shopping__element_footer"),a.innerHTML=`<span class="shopping__caption">Всего:</span>\n    <span class="shopping__total">${s.toLocaleString("ru-RU",{style:"currency",currency:"RUR"})}<span>`,e.appendChild(a),this.el.appendChild(e)}static renderLi(e,{id:n,productName:s,price:r},a){const i=document.createElement("li");return i.classList.add("shopping__element"),i.innerHTML=`<span class="shopping__counter">${e}</span>\n    <span class="shopping__productName">${s}</span>\n    <span class="shopping__qty">${a}</span>\n    <span class="shopping__price">${r.toLocaleString("ru-RU",{style:"currency",currency:"RUR"})}</span>\n    <span class="shopping__button"><button><img src="./images/cart-remove.svg"/></button></span>`,i.querySelector("button").addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),t.deleteProduct(n),console.log(o),o.render(),_.render(),i.style.opacity=0,setTimeout((()=>{y.render()}),200)})),i}}const y=new g(e.shopping),_=new class{constructor(e){this.el=e}render(){this.el.innerHTML="";const e=`<div class="header__container">        \n        <a href="#!" class="header__cart">\n            <img src="images/basket.svg" class="header__icon">\n            <span class="header__counter">${t.getQty()}</span>\n        </a>        \n    </div>`;this.el.innerHTML=e,this.el.querySelector(".header__cart").addEventListener("click",(e=>{e.preventDefault(),y.el.classList.add("active"),document.body.classList.add("lock"),function(e,t){if(e){if(!c.some((function(t){return t.targetElement===e}))){var n={targetElement:e,options:t||{}};c=[].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(c),[n]),i?window.requestAnimationFrame((function(){if(void 0===p){p={position:document.body.style.position,top:document.body.style.top,left:document.body.style.left};var e=window,t=e.scrollY,n=e.scrollX,s=e.innerHeight;document.body.style.position="fixed",document.body.style.top=-t,document.body.style.left=-n,setTimeout((function(){return window.requestAnimationFrame((function(){var e=s-window.innerHeight;e&&t>=s&&(document.body.style.top=-(t+e))}))}),300)}})):function(e){if(void 0===h){var t=!!e&&!0===e.reserveScrollBarGap,n=window.innerWidth-document.documentElement.clientWidth;if(t&&n>0){var s=parseInt(window.getComputedStyle(document.body).getPropertyValue("padding-right"),10);h=document.body.style.paddingRight,document.body.style.paddingRight=s+n+"px"}}void 0===u&&(u=document.body.style.overflow,document.body.style.overflow="hidden")}(t),i&&(e.ontouchstart=function(e){1===e.targetTouches.length&&(d=e.targetTouches[0].clientY)},e.ontouchmove=function(t){1===t.targetTouches.length&&function(e,t){var n=e.targetTouches[0].clientY-d;!v(e.target)&&(t&&0===t.scrollTop&&n>0||function(e){return!!e&&e.scrollHeight-e.scrollTop<=e.clientHeight}(t)&&n<0?m(e):e.stopPropagation())}(t,e)},l||(document.addEventListener("touchmove",m,r?{passive:!1}:void 0),l=!0))}}else console.error("disableBodyScroll unsuccessful - targetElement must be provided when calling disableBodyScroll on IOS devices.")}(document.body),y.render()}))}renderQty(){}}(e.header);o.render(),_.render(),y.render()})();