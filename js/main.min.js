(()=>{"use strict";const e={products:document.querySelector("#products"),header:document.querySelector("#header"),shopping:document.querySelector("#shopping"),spinner:document.querySelector("#spinner")},t=new class{constructor(){this.keyName="products",this.values=null!=localStorage.getItem(this.keyName)?JSON.parse(localStorage.getItem(this.keyName)):{},this.qty=this.countQty()}countQty(){let e=0;for(let t in this.values)e+=this.values[t];return e}getProducts(){return this.values}getQty(){return this.qty}saveProducts(){localStorage.setItem(this.keyName,JSON.stringify(this.values))}addProduct(e,t=1){this.qty+=t,this.values[e]=t,this.saveProducts()}deleteProduct(e){this.qty-=this.values[e],delete this.values[e],this.saveProducts()}switchProduct(e){let t;return e in this.values?(this.deleteProduct(e),t=!1):(this.addProduct(e),t=!0),{status:t,products:this.values}}};let n=new class{async getCatalog(){let e=await fetch("http://myjson.dit.upm.es/api/bins/9g4s");if(200!==e.status)throw new Error("Ошибка подключения");return await e.json()}};const s=new class{constructor(e){this.el=e}render(){this.el.innerHTML='<div class="spinner___icon"><img src="images/loader.svg"/></div>\n    <div class="spinner__logo"><img src="images/spinner.png" /></div>\n    '}show(){this.el.classList.add("visible")}hide(){this.el.classList.remove("visible")}}(e.spinner);class o{constructor(e){this.el=e,this.productList={},this.indexID()}async indexID(){try{let e=await n.getCatalog();this.productList=e.reduce(((e,t)=>(e[[t.id]]=t,e)),{})}catch(e){console.log(e)}}static labels(){return{activeClassLabel:"active",addLabel:"Добавить в корзину",removeLabel:"Удалить из корзины"}}async render(){this.el.innerHTML="";const e=t.getProducts(),i=document.createElement("ul");i.classList.add("products__container");try{s.show();let t=await n.getCatalog();s.hide(),t.forEach((t=>{const n={activeClass:"",activeText:""};t.id in e?(n.activeClass=o.labels().activeClassLabel,n.activeText=o.labels().removeLabel):(n.activeClass="",n.activeText=o.labels().addLabel),i.appendChild(o.renderElementLi(t,n))})),this.el.appendChild(i)}catch(e){console.log(e)}}getProduct(e){return this.productList[e]}static renderElementLi({id:e,productName:n,price:s,img:i},r){const a=document.createElement("li");return a.classList.add("products__item"),a.innerHTML=`<div class="products__inner">\n      <span class="products__title">${n}</span>\n      <img src="${i}" alt="${n}" class="products__img">\n      <div class="products__footer">          \n        <div class="products__price">\n        <img src="images/plugin.png" class="products__icon">\n        ${s.toLocaleString("ru-RU",{style:"currency",currency:"RUR"})}\n        </div>\n        <button class="${r.activeClass}">${r.activeText}</button>\n      </div>\n    <div>`,a.querySelector("button").addEventListener("click",(n=>{let{status:s}=t.switchProduct(e);s?(n.target.classList.add(o.labels().activeClassLabel),n.target.innerHTML=`${o.labels().removeLabel}`):(n.target.classList.remove(o.labels().activeClassLabel),n.target.innerHTML=`${o.labels().addLabel}`),b.render()})),a}}const i=new o(e.products);var r=!1;if("undefined"!=typeof window){var a={get passive(){r=!0}};window.addEventListener("testPassive",null,a),window.removeEventListener("testPassive",null,a)}var c="undefined"!=typeof window&&window.navigator&&window.navigator.platform&&(/iP(ad|hone|od)/.test(window.navigator.platform)||"MacIntel"===window.navigator.platform&&window.navigator.maxTouchPoints>1),l=[],d=!1,u=-1,p=void 0,h=void 0,v=void 0,m=function(e){return l.some((function(t){return!(!t.options.allowTouchMove||!t.options.allowTouchMove(e))}))},g=function(e){var t=e||window.event;return!!m(t.target)||t.touches.length>1||(t.preventDefault&&t.preventDefault(),!1)};class y{constructor(e){this.el=e,this.el.addEventListener("click",(e=>{var t;this.el.classList.remove("active"),document.body.classList.remove("lock"),i.render(),(t=document.body)?(l=l.filter((function(e){return e.targetElement!==t})),c&&(t.ontouchstart=null,t.ontouchmove=null,d&&0===l.length&&(document.removeEventListener("touchmove",g,r?{passive:!1}:void 0),d=!1)),c?function(){if(void 0!==h){var e=-parseInt(document.body.style.top,10),t=-parseInt(document.body.style.left,10);document.body.style.position=h.position,document.body.style.top=h.top,document.body.style.left=h.left,window.scrollTo(t,e),h=void 0}}():(void 0!==v&&(document.body.style.paddingRight=v,v=void 0),void 0!==p&&(document.body.style.overflow=p,p=void 0))):console.error("enableBodyScroll unsuccessful - targetElement must be provided when calling enableBodyScroll on IOS devices.")}))}render(){this.el.innerHTML="";const e=document.createElement("ul");e.classList.add("shopping__container"),e.addEventListener("click",(e=>e.stopPropagation()));let n=1,s=0;const o=document.createElement("li");o.classList.add("shopping__element","shopping__element_header"),o.innerHTML='<span class="shopping__counter">№ п/п</span>\n    <span class="shopping__productName">Наименование продукта</span>\n    <span class="shopping__qty">Коли&shy;чество</span>\n    <span class="shopping__price">Цена</span>\n    <span class="shopping__button"></span>',e.appendChild(o),Object.keys(t.values).forEach((o=>{const r=i.getProduct(o);if(!r)return;const a=t.values[o];e.appendChild(y.renderLi(n,r,a)),n++,s+=r.price}));const r=document.createElement("li");r.classList.add("shopping__element","shopping__element_footer"),r.innerHTML=`<span class="shopping__caption">Всего:</span>\n    <span class="shopping__total">${s.toLocaleString("ru-RU",{style:"currency",currency:"RUR"})}<span>`,e.appendChild(r),this.el.appendChild(e)}static renderLi(e,{id:n,productName:s,price:o},r){const a=document.createElement("li");return a.classList.add("shopping__element"),a.innerHTML=`<span class="shopping__counter">${e}</span>\n    <span class="shopping__productName">${s}</span>\n    <span class="shopping__qty">${r}</span>\n    <span class="shopping__price">${o.toLocaleString("ru-RU",{style:"currency",currency:"RUR"})}</span>\n    <span class="shopping__button"><button><img src="./images/cart-remove.svg"/></button></span>`,a.querySelector("button").addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),t.deleteProduct(n),console.log(i),b.render(),a.style.opacity=0,setTimeout((()=>{_.render()}),200)})),a}}const _=new y(e.shopping),b=new class{constructor(e){this.el=e}render(){this.el.innerHTML="";const e=`<div class="header__container">        \n        <a href="#!" class="header__cart">\n            <img src="images/basket.svg" class="header__icon">\n            <span class="header__counter">${t.getQty()}</span>\n        </a>        \n    </div>`;this.el.innerHTML=e,this.el.querySelector(".header__cart").addEventListener("click",(e=>{e.preventDefault(),_.el.classList.add("active"),document.body.classList.add("lock"),function(e,t){if(e){if(!l.some((function(t){return t.targetElement===e}))){var n={targetElement:e,options:t||{}};l=[].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(l),[n]),c?window.requestAnimationFrame((function(){if(void 0===h){h={position:document.body.style.position,top:document.body.style.top,left:document.body.style.left};var e=window,t=e.scrollY,n=e.scrollX,s=e.innerHeight;document.body.style.position="fixed",document.body.style.top=-t,document.body.style.left=-n,setTimeout((function(){return window.requestAnimationFrame((function(){var e=s-window.innerHeight;e&&t>=s&&(document.body.style.top=-(t+e))}))}),300)}})):function(e){if(void 0===v){var t=!!e&&!0===e.reserveScrollBarGap,n=window.innerWidth-document.documentElement.clientWidth;if(t&&n>0){var s=parseInt(window.getComputedStyle(document.body).getPropertyValue("padding-right"),10);v=document.body.style.paddingRight,document.body.style.paddingRight=s+n+"px"}}void 0===p&&(p=document.body.style.overflow,document.body.style.overflow="hidden")}(t),c&&(e.ontouchstart=function(e){1===e.targetTouches.length&&(u=e.targetTouches[0].clientY)},e.ontouchmove=function(t){1===t.targetTouches.length&&function(e,t){var n=e.targetTouches[0].clientY-u;!m(e.target)&&(t&&0===t.scrollTop&&n>0||function(e){return!!e&&e.scrollHeight-e.scrollTop<=e.clientHeight}(t)&&n<0?g(e):e.stopPropagation())}(t,e)},d||(document.addEventListener("touchmove",g,r?{passive:!1}:void 0),d=!0))}}else console.error("disableBodyScroll unsuccessful - targetElement must be provided when calling disableBodyScroll on IOS devices.")}(document.body),_.render()}))}renderQty(){}}(e.header);i.render(),b.render(),_.render(),s.render()})();